<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gym Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: #007bff;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    nav {
      display: flex;
      justify-content: space-around;
      background: #f1f1f1;
      padding: 0.5rem 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav button {
      background: none;
      border: none;
      font-size: 1rem;
      padding: 0.5rem;
      cursor: pointer;
    }
    section {
      padding: 1rem;
    }
    .hidden {
      display: none;
    }
    .user-buttons button {
      padding: 1rem;
      margin: 0.5rem;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      width: 45%;
      background: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .user-buttons i {
      margin-right: 8px;
    }
    input, select {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button.submit {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: 5px;
      font-size: 1rem;
      width: 100%;
    }
    .log-entry, .history-entry {
      background: white;
      border-radius: 5px;
      padding: 0.75rem;
      margin: 0.5rem 0;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .log-header {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .debug {
      font-size: 0.85rem;
      color: #777;
      margin-top: 0.5rem;
    }
    .filter-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .filter-row select {
      flex: 1;
    }
    .mic-btn {
      background: #ffc107;
      border: none;
      border-radius: 5px;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>üèãÔ∏è Gym Tracker</header>
  <nav>
    <button onclick="switchTab('home')">üè† Home</button>
    <button onclick="switchTab('history')">üìú History</button>
  </nav>

  <section id="home">
    <div>
      <label for="workout">Workout Name</label>
      <input id="workout" placeholder="e.g., Bench Press"/>
    </div>

    <div class="user-buttons">
      <button onclick="selectUser('Selim')"><i>üë§</i> Selim</button>
      <button onclick="selectUser('Friend')"><i>üë•</i> Friend</button>
    </div>

    <div>
      <label for="weight">Weight (kg)</label>
      <input id="weight" type="number" />
      <label for="reps">Reps</label>
      <input id="reps" type="number" />
      <label for="rpe">Difficulty (RPE)</label>
      <input id="rpe" type="number" min="1" max="10" />
      <button class="submit" onclick="submitSet()">‚ûï Add Set</button>
      <button class="mic-btn" onclick="startListening()">üé§ Voice Input</button>
    </div>

    <div class="debug" id="debug"></div>

    <h3>Today's Log</h3>
    <div id="today-log"></div>
  </section>

  <section id="history" class="hidden">
    <div class="filter-row">
      <select id="dateFilter"></select>
      <select id="workoutFilter"></select>
    </div>
    <div id="history-log"></div>
  </section>

  <script>
    const logs = JSON.parse(localStorage.getItem('gymLogs') || '[]');
    const todayKey = new Date().toISOString().split('T')[0];
    const todayLog = logs.filter(log => log.date === todayKey);
    let currentUser = null;

    function switchTab(tab) {
      document.getElementById('home').classList.add('hidden');
      document.getElementById('history').classList.add('hidden');
      document.getElementById(tab).classList.remove('hidden');
      if (tab === 'history') renderHistory();
    }

    function selectUser(user) {
      currentUser = user;
      logDebug(`‚úÖ Selected: ${user}`);
    }

    function submitSet() {
      const workout = document.getElementById('workout').value.trim();
      const weight = +document.getElementById('weight').value;
      const reps = +document.getElementById('reps').value;
      const rpe = +document.getElementById('rpe').value;
      const date = todayKey;

      if (!currentUser || !workout || !weight || !reps || !rpe) return alert("Fill all fields and select user");

      const entry = { user: currentUser, workout, weight, reps, rpe, date };
      logs.push(entry);
      localStorage.setItem('gymLogs', JSON.stringify(logs));
      renderToday();
    }

    function renderToday() {
      const container = document.getElementById('today-log');
      container.innerHTML = '';

      ['Selim', 'Friend'].forEach(user => {
        const userLogs = logs.filter(log => log.user === user && log.date === todayKey);
        const workouts = [...new Set(userLogs.map(log => log.workout))];

        workouts.forEach(workout => {
          const logsForWorkout = userLogs.filter(log => log.workout === workout);
          const maxWeight = Math.max(...logsForWorkout.map(log => log.weight));
          const header = document.createElement('div');
          header.className = 'log-entry';
          header.innerHTML = `<div class="log-header">${user} - ${workout} (Max: ${maxWeight}kg)</div>`;

          logsForWorkout.forEach(log => {
            const line = document.createElement('div');
            line.textContent = `${log.reps} reps √ó ${log.weight}kg (RPE ${log.rpe})`;
            header.appendChild(line);
          });

          container.appendChild(header);
        });
      });
    }

    function renderHistory() {
      const dateSelect = document.getElementById('dateFilter');
      const workoutSelect = document.getElementById('workoutFilter');
      const container = document.getElementById('history-log');
      container.innerHTML = '';

      const uniqueDates = [...new Set(logs.map(log => log.date))].sort().reverse();
      const uniqueWorkouts = [...new Set(logs.map(log => log.workout))];

      dateSelect.innerHTML = `<option value="">All Dates</option>` + uniqueDates.map(d => `<option>${d}</option>`).join('');
      workoutSelect.innerHTML = `<option value="">All Workouts</option>` + uniqueWorkouts.map(w => `<option>${w}</option>`).join('');

      const selectedDate = dateSelect.value;
      const selectedWorkout = workoutSelect.value;

      const filtered = logs.filter(log =>
        (!selectedDate || log.date === selectedDate) &&
        (!selectedWorkout || log.workout === selectedWorkout)
      );

      const grouped = {};

      filtered.forEach(log => {
        if (!grouped[log.date]) grouped[log.date] = {};
        if (!grouped[log.date][log.user]) grouped[log.date][log.user] = {};
        if (!grouped[log.date][log.user][log.workout]) grouped[log.date][log.user][log.workout] = [];
        grouped[log.date][log.user][log.workout].push(log);
      });

      for (const date in grouped) {
        const block = document.createElement('div');
        block.innerHTML = `<div class="log-header">${date}</div>`;
        for (const user in grouped[date]) {
          for (const workout in grouped[date][user]) {
            const logs = grouped[date][user][workout];
            const div = document.createElement('div');
            div.className = 'history-entry';
            div.innerHTML = `<strong>${user} - ${workout}</strong><br/>` + logs.map(l => `${l.reps} √ó ${l.weight}kg (RPE ${l.rpe})`).join('<br/>');
            block.appendChild(div);
          }
        }
        container.appendChild(block);
      }
    }

    function logDebug(msg) {
      const el = document.getElementById('debug');
      el.textContent = msg;
    }

    function startListening() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return alert("Voice recognition not supported");

      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.continuous = false;

      recognition.start();
      logDebug("üé§ Voice started...");

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        logDebug(`üó£ Transcribed: "${transcript}"`);
        const text = transcript.replace(/kilograms?|kg/g, '').replace(/difficulty/g, '').trim();

        const wordsToNumbers = {
          'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4,
          'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9,
          'ten': 10, 'eleven': 11, 'twelve': 12, 'for': 4, 'to': 2
        };

        const parts = text.split(/\s+/).map(word => {
          if (!isNaN(word)) return +word;
          return wordsToNumbers[word] !== undefined ? wordsToNumbers[word] : NaN;
        }).filter(n => !isNaN(n));

        if (transcript.includes('stop')) {
          if (!currentUser || !document.getElementById('workout').value) return;
          const w = document.getElementById('workout').value;
          for (let i = logs.length - 1; i >= 0; i--) {
            if (logs[i].user === currentUser && logs[i].workout === w && logs[i].date === todayKey) logs.splice(i, 1);
          }
          localStorage.setItem('gymLogs', JSON.stringify(logs));
          renderToday();
          logDebug("üõë Set count reset for this workout");
          return;
        }

        if (parts.length >= 3) {
          document.getElementById('weight').value = parts[0];
          document.getElementById('reps').value = parts[1];
          document.getElementById('rpe').value = parts[2];
          submitSet();
        } else {
          logDebug("‚ùå Could not extract 3 values.");
        }
      };

      recognition.onerror = (e) => logDebug("‚ö†Ô∏è Error: " + e.error);
      recognition.onend = () => logDebug("üé§ Ended");
    }

    // Init
    renderToday();
    document.getElementById('dateFilter').onchange = renderHistory;
    document.getElementById('workoutFilter').onchange = renderHistory;
  </script>
</body>
</html>