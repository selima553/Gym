<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gym Tracker</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      background: #f0f2f5;
      padding: 10px;
    }

    h1 {
      text-align: center;
      margin-top: 10px;
    }

    nav {
      display: flex;
      justify-content: space-around;
      background: #fff;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    nav button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #e0e0e0;
      font-weight: bold;
    }

    nav button.active {
      background: #007bff;
      color: white;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    input, select, button {
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .user-buttons {
      display: flex;
      gap: 10px;
    }

    .user-buttons button {
      flex: 1;
      background: #007bff;
      color: white;
      border: none;
    }

    .log-group {
      background: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .log-group h4 {
      margin-top: 0;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }

    .log-entry {
      margin-left: 10px;
      padding: 4px 0;
    }

    .edit-btn {
      float: right;
      background: transparent;
      border: none;
      color: #007bff;
      cursor: pointer;
    }

    #filters {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    #debug {
      font-size: 14px;
      margin-top: 10px;
      background: #fff3cd;
      border-left: 4px solid #ffecb5;
      padding: 10px;
      border-radius: 6px;
    }

    #voiceBtn {
      background: #28a745;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>üèãÔ∏è Gym Tracker</h1>

<nav>
  <button onclick="switchTab('home')" id="btn-home" class="active">Home</button>
  <button onclick="switchTab('history')" id="btn-history">History</button>
</nav>

<section id="home" class="active">
  <select id="exerciseSelect" onchange="handleExerciseChange(this.value)">
    <option value="">-- Select Exercise --</option>
  </select>
  <input type="text" id="newExercise" placeholder="Add new exercise" />
  <button onclick="addExercise()">Add Exercise</button>

  <div class="user-buttons">
    <button onclick="startSet('Selim')">Selim</button>
    <button onclick="startSet('Friend')">Friend</button>
  </div>

  <div id="setDetails" style="display:none;">
    <p id="setInfo"></p>
    <input type="number" id="weight" placeholder="Weight (kg)" />
    <input type="number" id="reps" placeholder="Reps" />
    <input type="number" id="rpe" placeholder="RPE (1-10)" />
    <button onclick="submitSet()">Submit Set</button>
    <button id="voiceBtn" onclick="startVoiceInput()">üé§ Voice Input</button>
    <div id="debug"></div>
  </div>

  <h3>Today's Log</h3>
  <div id="logList"></div>
</section>

<section id="history">
  <div id="filters">
    <select id="filterExercise" onchange="renderHistory()">
      <option value="">-- All Exercises --</option>
    </select>
    <select id="filterDate" onchange="renderHistory()">
      <option value="">-- All Dates --</option>
    </select>
  </div>
  <div id="historyList"></div>
</section>

<script>
  const today = new Date().toISOString().split("T")[0];
  let workoutLog = JSON.parse(localStorage.getItem("workoutLog")) || [];
  let exercises = JSON.parse(localStorage.getItem("exercises")) || [];
  let setCounts = JSON.parse(localStorage.getItem("setCounts")) || {};
  let currentExercise = '';
  let currentUser = '';
  let recognition;

  function switchTab(tabId) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.getElementById('btn-' + tabId).classList.add('active');
    if (tabId === 'history') renderHistory();
  }

  function addExercise() {
    const name = document.getElementById('newExercise').value.trim();
    if (name && !exercises.includes(name)) {
      exercises.push(name);
      localStorage.setItem("exercises", JSON.stringify(exercises));
      updateExerciseDropdowns();
      document.getElementById('exerciseSelect').value = name;
      handleExerciseChange(name);
      document.getElementById('newExercise').value = '';
    }
  }

  function updateExerciseDropdowns() {
    const selects = [document.getElementById('exerciseSelect'), document.getElementById('filterExercise')];
    selects.forEach(select => {
      select.innerHTML = '<option value="">-- Select Exercise --</option>';
      exercises.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.text = name;
        select.appendChild(option);
      });
    });
  }

  function handleExerciseChange(name) {
    currentExercise = name;
  }

  function startSet(user) {
    if (!currentExercise) {
      alert("Please select an exercise first.");
      return;
    }
    currentUser = user;
    const key = `${user}_${currentExercise}`;
    if (!setCounts[key]) setCounts[key] = 1;
    document.getElementById("setInfo").textContent = `User: ${user}, Set: ${setCounts[key]} (${currentExercise})`;
    document.getElementById("setDetails").style.display = "block";
  }

  function submitSet() {
    const weight = document.getElementById("weight").value;
    const reps = document.getElementById("reps").value;
    const rpe = document.getElementById("rpe").value;
    const key = `${currentUser}_${currentExercise}`;
    const setNum = setCounts[key] || 1;

    const entry = {
      user: currentUser,
      exercise: currentExercise,
      set: setNum,
      weight,
      reps,
      rpe,
      date: today
    };

    workoutLog.push(entry);
    setCounts[key] = setNum + 1;
    localStorage.setItem("workoutLog", JSON.stringify(workoutLog));
    localStorage.setItem("setCounts", JSON.stringify(setCounts));

    document.getElementById("setDetails").style.display = "none";
    document.getElementById("weight").value = '';
    document.getElementById("reps").value = '';
    document.getElementById("rpe").value = '';
    renderTodayLog();
  }

  function renderTodayLog() {
    const logContainer = document.getElementById("logList");
    logContainer.innerHTML = '';
    const grouped = {};

    for (let entry of workoutLog) {
      if (entry.date !== today) continue;
      if (!grouped[entry.user]) grouped[entry.user] = {};
      if (!grouped[entry.user][entry.exercise]) grouped[entry.user][entry.exercise] = [];
      grouped[entry.user][entry.exercise].push(entry);
    }

    for (let user in grouped) {
      const userGroup = document.createElement('div');
      userGroup.className = 'log-group';
      userGroup.innerHTML = `<h4>${user}</h4>`;
      for (let ex in grouped[user]) {
        userGroup.innerHTML += `<strong>${ex}</strong>`;
        grouped[user][ex].forEach(set => {
          userGroup.innerHTML += `<div class="log-entry">Set ${set.set}: ${set.weight}kg x ${set.reps} (RPE ${set.rpe})</div>`;
        });
      }
      logContainer.appendChild(userGroup);
    }
  }

  function renderHistory() {
    const filterEx = document.getElementById("filterExercise").value;
    const filterDate = document.getElementById("filterDate").value;
    const list = document.getElementById("historyList");
    list.innerHTML = '';
    const grouped = {};

    for (let entry of workoutLog) {
      if (filterEx && entry.exercise !== filterEx) continue;
      if (filterDate && entry.date !== filterDate) continue;
      if (!grouped[entry.date]) grouped[entry.date] = {};
      if (!grouped[entry.date][entry.user]) grouped[entry.date][entry.user] = {};
      if (!grouped[entry.date][entry.user][entry.exercise]) grouped[entry.date][entry.user][entry.exercise] = [];
      grouped[entry.date][entry.user][entry.exercise].push(entry);
    }

    for (let date in grouped) {
      const dateGroup = document.createElement("div");
      dateGroup.className = 'log-group';
      dateGroup.innerHTML = `<h4>${date}</h4>`;
      for (let user in grouped[date]) {
        dateGroup.innerHTML += `<strong>${user}</strong><br>`;
        for (let ex in grouped[date][user]) {
          dateGroup.innerHTML += `<em>${ex}</em><br>`;
          grouped[date][user][ex].forEach(set => {
            dateGroup.innerHTML += `<div class="log-entry">Set ${set.set}: ${set.weight}kg x ${set.reps} (RPE ${set.rpe})</div>`;
          });
        }
      }
      list.appendChild(dateGroup);
    }
  }

  function populateFilterDates() {
    const dates = new Set(workoutLog.map(entry => entry.date));
    const dateSelect = document.getElementById("filterDate");
    dateSelect.innerHTML = '<option value="">-- All Dates --</option>';
    [...dates].sort((a,b) => b.localeCompare(a)).forEach(date => {
      const opt = document.createElement("option");
      opt.value = date;
      opt.text = date;
      dateSelect.appendChild(opt);
    });
  }

  // üîä Voice Recognition
  function normalizeNumberWords(text) {
    const words = {
      zero: '0', one: '1', two: '2', three: '3', four: '4',
      five: '5', six: '6', seven: '7', eight: '8', nine: '9',
      ten: '10', eleven: '11', twelve: '12', thirteen: '13',
      fourteen: '14', fifteen: '15', sixteen: '16', seventeen: '17',
      eighteen: '18', nineteen: '19', twenty: '20'
    };
    for (let word in words) {
      const regex = new RegExp(`\\b${word}\\b`, 'gi');
      text = text.replace(regex, words[word]);
    }
    return text;
  }

  function smartSplit(text) {
    text = normalizeNumberWords(text);
    let match = text.match(/\d+/g);
    if (!match) return null;
    if (match.length >= 3) return match.slice(0, 3);
    if (match.length === 1 && match[0].length === 3) return match[0].split('');
    if (match.length === 2 && match[1].length === 2) return [match[0], match[1][0], match[1][1]];
    if (match.length === 2 && match[0].length === 4) return [match[0].substring(0,2), match[0].substring(2), match[1]];
    return null;
  }

  function startVoiceInput() {
    if (!currentExercise || !currentUser) {
      alert("Select user and exercise first.");
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Speech Recognition not supported.");
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    document.getElementById("debug").innerText = "üéô Listening...";
    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      document.getElementById("debug").innerText = `üó£ Transcribed: "${transcript}"`;
      const numbers = smartSplit(transcript);
      if (numbers && numbers.length === 3) {
        document.getElementById("weight").value = numbers[0];
        document.getElementById("reps").value = numbers[1];
        document.getElementById("rpe").value = numbers[2];
        submitSet();
        document.getElementById("debug").innerText += "\n‚úÖ Set submitted!";
      } else {
        document.getElementById("debug").innerText += "\n‚ùå Could not extract 3 valid numbers.";
      }
    };

    recognition.onerror = (event) => {
      document.getElementById("debug").innerText = `‚ùå Error: ${event.error}`;
    };

    recognition.onend = () => {
      if (!recognition.stopped) {
        document.getElementById("debug").innerText += "\nüé§ Ended";
      }
    };
  }

  window.onload = () => {
    updateExerciseDropdowns();
    populateFilterDates();
    renderTodayLog();
  };
</script>

</body>
</html>