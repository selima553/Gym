<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gym Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; font-family: sans-serif; }
    body { margin: 0; padding: 0; background: #f5f5f5; color: #333; }
    .tabs { display: flex; justify-content: space-around; background: #111; color: white; }
    .tabs button { flex: 1; padding: 1em; background: none; border: none; color: inherit; font-weight: bold; }
    .tabs button.active { background: #222; }
    .tab-content { padding: 1em; }

    select, input, button {
      padding: 0.6em;
      margin: 0.4em 0;
      width: 100%;
      max-width: 400px;
    }

    #todayLog, #historyLog { margin-top: 1em; }

    .log-block {
      background: white;
      margin: 0.5em 0;
      padding: 0.5em;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .log-header {
      font-weight: bold;
      margin-bottom: 0.3em;
    }

    .microphone {
      font-size: 1.5em;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 2.5em;
      height: 2.5em;
      margin-top: 0.5em;
    }

    .debug {
      background: #222;
      color: lime;
      font-size: 0.8em;
      padding: 0.5em;
      margin-top: 0.5em;
      white-space: pre-wrap;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<div class="tabs">
  <button onclick="showTab('home')" class="active">Home</button>
  <button onclick="showTab('history')">History</button>
</div>

<div id="home" class="tab-content">
  <h2>Workout Logger</h2>
  <select id="exerciseSelect">
    <option value="">Select Exercise</option>
  </select>
  <input type="text" id="newExercise" placeholder="Add new exercise">
  <button onclick="addExercise()">Add Exercise</button>

  <select id="userSelect">
    <option value="">Select User</option>
    <option value="Selim">Selim</option>
    <option value="Friend">Friend</option>
  </select>

  <input type="number" id="weight" placeholder="Weight (kg)">
  <input type="number" id="reps" placeholder="Reps">
  <input type="number" id="rpe" placeholder="Difficulty (RPE)">
  <button onclick="submitSet()">Submit Set</button>
  <button class="microphone" onclick="startListening()">üé§</button>

  <div class="debug" id="debug">Voice debug will show here...</div>

  <div id="todayLog"></div>
</div>

<div id="history" class="tab-content" style="display:none">
  <h2>Workout History</h2>
  <select id="filterWorkout" onchange="renderHistory()">
    <option value="">All Workouts</option>
  </select>
  <select id="filterDate" onchange="renderHistory()">
    <option value="">All Dates</option>
  </select>
  <div id="historyLog"></div>
</div>

<script>
let logs = JSON.parse(localStorage.getItem("gymLogs")) || [];
let exercises = JSON.parse(localStorage.getItem("exercises")) || [];
let currentDate = new Date().toISOString().split('T')[0];

function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(div => div.style.display = 'none');
  document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tab).style.display = 'block';
  document.querySelector(`.tabs button[onclick="showTab('${tab}')"]`).classList.add('active');

  if (tab === 'history') renderHistory();
}

function addExercise() {
  const newEx = document.getElementById("newExercise").value.trim();
  if (newEx && !exercises.includes(newEx)) {
    exercises.push(newEx);
    localStorage.setItem("exercises", JSON.stringify(exercises));
    updateExerciseDropdown();
  }
  document.getElementById("newExercise").value = "";
}

function updateExerciseDropdown() {
  const select = document.getElementById("exerciseSelect");
  select.innerHTML = '<option value="">Select Exercise</option>';
  exercises.forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex;
    opt.textContent = ex;
    select.appendChild(opt);
  });

  const filterSelect = document.getElementById("filterWorkout");
  filterSelect.innerHTML = '<option value="">All Workouts</option>';
  exercises.forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex;
    opt.textContent = ex;
    filterSelect.appendChild(opt);
  });
}

function submitSet() {
  const exercise = document.getElementById("exerciseSelect").value;
  const user = document.getElementById("userSelect").value;
  const weight = parseInt(document.getElementById("weight").value);
  const reps = parseInt(document.getElementById("reps").value);
  const rpe = parseInt(document.getElementById("rpe").value);

  if (!exercise || !user || isNaN(weight) || isNaN(reps) || isNaN(rpe)) return;

  logs.push({ date: currentDate, exercise, user, weight, reps, rpe });
  localStorage.setItem("gymLogs", JSON.stringify(logs));

  renderTodayLog();
  document.getElementById("weight").value = "";
  document.getElementById("reps").value = "";
  document.getElementById("rpe").value = "";
}

function renderTodayLog() {
  const today = logs.filter(log => log.date === currentDate);
  const grouped = {};

  today.forEach(log => {
    if (!grouped[log.user]) grouped[log.user] = {};
    if (!grouped[log.user][log.exercise]) grouped[log.user][log.exercise] = [];
    grouped[log.user][log.exercise].push(log);
  });

  const container = document.getElementById("todayLog");
  container.innerHTML = "<h3>Today's Log</h3>";

  for (let user in grouped) {
    const userDiv = document.createElement("div");
    userDiv.innerHTML = `<h4>${user}</h4>`;
    for (let ex in grouped[user]) {
      const exDiv = document.createElement("div");
      exDiv.innerHTML = `<strong>${ex}</strong>`;
      grouped[user][ex].forEach(set => {
        const setDiv = document.createElement("div");
        setDiv.className = "log-block";
        setDiv.textContent = `${set.weight}kg x ${set.reps} reps (RPE ${set.rpe})`;
        exDiv.appendChild(setDiv);
      });
      userDiv.appendChild(exDiv);
    }
    container.appendChild(userDiv);
  }
}

function renderHistory() {
  const filterWorkout = document.getElementById("filterWorkout").value;
  const filterDate = document.getElementById("filterDate").value;
  const filtered = logs.filter(log => 
    (!filterWorkout || log.exercise === filterWorkout) &&
    (!filterDate || log.date === filterDate)
  );

  const grouped = {};

  filtered.forEach(log => {
    if (!grouped[log.date]) grouped[log.date] = {};
    if (!grouped[log.date][log.user]) grouped[log.date][log.user] = {};
    if (!grouped[log.date][log.user][log.exercise]) grouped[log.date][log.user][log.exercise] = [];
    grouped[log.date][log.user][log.exercise].push(log);
  });

  const container = document.getElementById("historyLog");
  container.innerHTML = "";

  for (let date in grouped) {
    const dateDiv = document.createElement("div");
    dateDiv.innerHTML = `<h4>${date}</h4>`;
    for (let user in grouped[date]) {
      const userDiv = document.createElement("div");
      userDiv.innerHTML = `<h5>${user}</h5>`;
      for (let ex in grouped[date][user]) {
        const exDiv = document.createElement("div");
        exDiv.innerHTML = `<strong>${ex}</strong>`;
        grouped[date][user][ex].forEach(set => {
          const setDiv = document.createElement("div");
          setDiv.className = "log-block";
          setDiv.textContent = `${set.weight}kg x ${set.reps} reps (RPE ${set.rpe})`;
          exDiv.appendChild(setDiv);
        });
        userDiv.appendChild(exDiv);
      }
      dateDiv.appendChild(userDiv);
    }
    container.appendChild(dateDiv);
  }

  // Populate date dropdown
  const dateSet = new Set(logs.map(log => log.date));
  const filterDate = document.getElementById("filterDate");
  filterDate.innerHTML = '<option value="">All Dates</option>';
  dateSet.forEach(date => {
    const opt = document.createElement("option");
    opt.value = date;
    opt.textContent = date;
    filterDate.appendChild(opt);
  });
}

function startListening() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Voice recognition not supported on this browser.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  const debug = document.getElementById("debug");
  debug.textContent = "üé§ Listening...";

  recognition.onstart = () => debug.textContent = "üé§ Voice started...";
  recognition.onerror = (e) => debug.textContent = "‚ùå Error: " + e.error;
  recognition.onend = () => debug.textContent += "\n‚úÖ Done listening.";

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.trim();
    debug.textContent = `üìù Transcribed: "${transcript}"`;

    const numbers = transcript.match(/\d+/g);
    if (numbers && numbers.length >= 3) {
      document.getElementById("weight").value = numbers[0];
      document.getElementById("reps").value = numbers[1];
      document.getElementById("rpe").value = numbers[2];
      submitSet();
      debug.textContent += `\n‚úÖ Set added: ${numbers[0]}kg x ${numbers[1]} (RPE ${numbers[2]})`;
    } else {
      debug.textContent += "\n‚ùå Please say three numbers like: 6 12 7";
    }
  };

  recognition.start();
}

updateExerciseDropdown();
renderTodayLog();
</script>
</body>
</html>
