<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gym Tracker with Voice Input</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 10px;
    }

    h1 {
      text-align: center;
    }

    nav {
      display: flex;
      justify-content: space-around;
      background: white;
      padding: 10px;
      position: sticky;
      top: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    nav button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #e0e0e0;
    }

    nav button.active {
      background: #007bff;
      color: white;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    select, input, button {
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .user-buttons {
      display: flex;
      gap: 10px;
    }

    .user-buttons button {
      flex: 1;
      background: #007bff;
      color: white;
      border: none;
    }

    .log-group {
      background: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .log-entry {
      padding-left: 10px;
    }

    #debug {
      font-family: monospace;
      font-size: 14px;
      color: #444;
      margin-top: 10px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
<h1>üèãÔ∏è Gym Tracker</h1>

<nav>
  <button onclick="switchTab('home')" id="btn-home" class="active">Home</button>
  <button onclick="switchTab('history')" id="btn-history">History</button>
</nav>

<section id="home" class="active">
  <select id="exerciseSelect" onchange="handleExerciseChange(this.value)">
    <option value="">-- Select Exercise --</option>
  </select>
  <input type="text" id="newExercise" placeholder="Add new exercise" />
  <button onclick="addExercise()">Add Exercise</button>

  <div class="user-buttons">
    <button onclick="startSet('Selim')">Selim</button>
    <button onclick="startSet('Friend')">Friend</button>
  </div>

  <div id="setDetails" style="display:none;">
    <p id="setInfo"></p>
    <button onclick="startVoiceInput()">üé§ Start Voice Input</button>
    <input type="number" id="weight" placeholder="Weight (kg)" />
    <input type="number" id="reps" placeholder="Reps" />
    <input type="number" id="rpe" placeholder="RPE (1-10)" />
    <button onclick="submitSet()">Submit Set</button>
    <div id="debug"></div>
  </div>

  <h3>Today's Log</h3>
  <div id="logList"></div>
</section>

<section id="history">
  <select id="filterExercise" onchange="renderHistory()">
    <option value="">-- All Exercises --</option>
  </select>
  <select id="filterDate" onchange="renderHistory()">
    <option value="">-- All Dates --</option>
  </select>
  <div id="historyList"></div>
</section>

<script>
  const today = new Date().toISOString().split("T")[0];
  let workoutLog = JSON.parse(localStorage.getItem("workoutLog")) || [];
  let exercises = JSON.parse(localStorage.getItem("exercises")) || [];
  let setCounts = JSON.parse(localStorage.getItem("setCounts")) || {};
  let currentExercise = '';
  let currentUser = '';

  function switchTab(tabId) {
    document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");
    document.getElementById("btn-" + tabId).classList.add("active");
    if (tabId === "history") renderHistory();
  }

  function addExercise() {
    const name = document.getElementById("newExercise").value.trim();
    if (name && !exercises.includes(name)) {
      exercises.push(name);
      localStorage.setItem("exercises", JSON.stringify(exercises));
      updateExerciseDropdowns();
      document.getElementById("exerciseSelect").value = name;
      handleExerciseChange(name);
      document.getElementById("newExercise").value = '';
    }
  }

  function updateExerciseDropdowns() {
    const selects = [document.getElementById("exerciseSelect"), document.getElementById("filterExercise")];
    selects.forEach(select => {
      select.innerHTML = '<option value="">-- Select Exercise --</option>';
      exercises.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.text = name;
        select.appendChild(opt);
      });
    });
  }

  function handleExerciseChange(name) {
    currentExercise = name;
  }

  function startSet(user) {
    if (!currentExercise) return alert("Please select an exercise first.");
    currentUser = user;
    const key = `${user}_${currentExercise}`;
    if (!setCounts[key]) setCounts[key] = 1;
    document.getElementById("setInfo").textContent = `User: ${user}, Set ${setCounts[key]} (${currentExercise})`;
    document.getElementById("setDetails").style.display = "block";
  }

  function submitSet() {
    const weight = document.getElementById("weight").value;
    const reps = document.getElementById("reps").value;
    const rpe = document.getElementById("rpe").value;
    if (!weight || !reps || !rpe) return alert("Fill all fields");
    const key = `${currentUser}_${currentExercise}`;
    const setNum = setCounts[key] || 1;
    const entry = { user: currentUser, exercise: currentExercise, set: setNum, weight, reps, rpe, date: today };
    workoutLog.push(entry);
    setCounts[key] = setNum + 1;
    localStorage.setItem("workoutLog", JSON.stringify(workoutLog));
    localStorage.setItem("setCounts", JSON.stringify(setCounts));
    document.getElementById("weight").value = '';
    document.getElementById("reps").value = '';
    document.getElementById("rpe").value = '';
    document.getElementById("setDetails").style.display = "none";
    renderTodayLog();
  }

  function renderTodayLog() {
    const container = document.getElementById("logList");
    container.innerHTML = '';
    const grouped = {};
    for (let e of workoutLog) {
      if (e.date !== today) continue;
      if (!grouped[e.user]) grouped[e.user] = {};
      if (!grouped[e.user][e.exercise]) grouped[e.user][e.exercise] = [];
      grouped[e.user][e.exercise].push(e);
    }
    for (let user in grouped) {
      const group = document.createElement("div");
      group.className = "log-group";
      group.innerHTML = `<h4>${user}</h4>`;
      for (let ex in grouped[user]) {
        group.innerHTML += `<strong>${ex}</strong>`;
        grouped[user][ex].forEach(set => {
          group.innerHTML += `<div class="log-entry">Set ${set.set}: ${set.weight}kg x ${set.reps} (RPE ${set.rpe})</div>`;
        });
      }
      container.appendChild(group);
    }
  }

  function renderHistory() {
    const filterEx = document.getElementById("filterExercise").value;
    const filterDate = document.getElementById("filterDate").value;
    const container = document.getElementById("historyList");
    container.innerHTML = '';
    const grouped = {};
    for (let e of workoutLog) {
      if (filterEx && e.exercise !== filterEx) continue;
      if (filterDate && e.date !== filterDate) continue;
      if (!grouped[e.date]) grouped[e.date] = {};
      if (!grouped[e.date][e.user]) grouped[e.date][e.user] = {};
      if (!grouped[e.date][e.user][e.exercise]) grouped[e.date][e.user][e.exercise] = [];
      grouped[e.date][e.user][e.exercise].push(e);
    }
    for (let date in grouped) {
      const group = document.createElement("div");
      group.className = "log-group";
      group.innerHTML = `<h4>${date}</h4>`;
      for (let user in grouped[date]) {
        group.innerHTML += `<strong>${user}</strong><br>`;
        for (let ex in grouped[date][user]) {
          group.innerHTML += `<em>${ex}</em><br>`;
          grouped[date][user][ex].forEach(set => {
            group.innerHTML += `<div class="log-entry">Set ${set.set}: ${set.weight}kg x ${set.reps} (RPE ${set.rpe})</div>`;
          });
        }
      }
      container.appendChild(group);
    }
    populateFilterDates();
  }

  function populateFilterDates() {
    const dates = new Set(workoutLog.map(e => e.date));
    const select = document.getElementById("filterDate");
    select.innerHTML = '<option value="">-- All Dates --</option>';
    [...dates].sort((a,b) => b.localeCompare(a)).forEach(date => {
      const opt = document.createElement("option");
      opt.value = date;
      opt.text = date;
      select.appendChild(opt);
    });
  }

  function startVoiceInput() {
    const debug = document.getElementById("debug");
    if (!('webkitSpeechRecognition' in window)) {
      debug.textContent = "‚ùå Voice recognition not supported in this browser.";
      return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    debug.textContent = "üé§ Listening...";

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript.toLowerCase();
      debug.textContent = `üó£ Transcribed: "${transcript}"\n`;

      const weightMatch = transcript.match(/(\d+)\s*kilogram/);
      const difficultyMatch = transcript.match(/difficulty\s*(\d+)/);
      const middleNumberMatch = transcript.match(/kilogram(?:s)?\s*(\d+)\s*difficulty/);

      if (weightMatch && middleNumberMatch && difficultyMatch) {
        const weight = parseInt(weightMatch[1]);
        const reps = parseInt(middleNumberMatch[1]);
        const rpe = parseInt(difficultyMatch[1]);

        document.getElementById("weight").value = weight;
        document.getElementById("reps").value = reps;
        document.getElementById("rpe").value = rpe;
        debug.textContent += `‚úÖ Extracted: ${weight}kg x ${reps} (RPE ${rpe})\nüé§ Ended`;
      } else {
        debug.textContent += "‚ùå Could not extract 3 values.\nüé§ Ended";
      }
    };

    recognition.onerror = function(event) {
      debug.textContent += `‚ùå Error: ${event.error}\nüé§ Ended`;
    };

    recognition.onend = function() {
      if (!debug.textContent.includes("Ended")) debug.textContent += "üé§ Ended";
    };

    recognition.start();
  }

  window.onload = () => {
    updateExerciseDropdowns();
    populateFilterDates();
    renderTodayLog();
  };
</script>
</body>
</html>